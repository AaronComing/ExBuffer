<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Exbuffer by play175</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Exbuffer</h1>
        <p>ExBuffer，NodeJs的TCP中的粘包、分包问题的解决方案！</p>
        <p class="view"><a href="https://github.com/play175/ExBuffer">View the Project on GitHub <small>play175/ExBuffer</small></a></p>
        <ul>
          <li><a href="https://github.com/play175/ExBuffer/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/play175/ExBuffer/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/play175/ExBuffer">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <p>ExBuffer，NodeJs的TCP中的粘包、分包问题的解决方案！</p>

<p>推荐结合ByteBuffer来做通信协议！<a href="https://github.com/play175/ByteBuffer">https://github.com/play175/ByteBuffer</a></p>

<div class="highlight">
<pre><span class="kd">var</span> <span class="nx">ExBuffer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./ExBuffer'</span><span class="p">);</span>

<span class="cm">/*************************基本操作****************************/</span>

<span class="c1">//构造一个ExBuffer，采用4个字节（uint32无符号整型）表示包长，而且是little endian 字节序</span>
<span class="kd">var</span> <span class="nx">exBuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExBuffer</span><span class="p">().</span><span class="nx">uint32Head</span><span class="p">().</span><span class="nx">littleEndian</span><span class="p">();</span>
<span class="c1">//或者构造一个ExBuffer，采用2个字节（ushort型）表示包长，而且是big endian 字节序 (默认)</span>
<span class="kd">var</span> <span class="nx">exBuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExBuffer</span><span class="p">().</span><span class="nx">ushortHead</span><span class="p">().</span><span class="nx">bigEndian</span><span class="p">();</span>

<span class="c1">//只要收到满足的包就会触发事件</span>
<span class="nx">exBuffer</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'&gt;&gt; receive data,length:'</span><span class="o">+</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="c1">//console.log(buffer);</span>
<span class="p">});</span>


<span class="c1">//传入一个9字节长的数据，分多次put （对应于TCP中的分包的情况）</span>
<span class="nx">exBuffer</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">9</span><span class="p">]));</span>
<span class="nx">exBuffer</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">]));</span>
<span class="nx">exBuffer</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">([</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]));</span>

<span class="c1">//传入一个3个字节的数据和一个6个字节的数据，一次put（对应于TCP中的粘包的情况）</span>
<span class="nx">exBuffer</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]));</span>


<span class="c1">//大数据处理测试 (20MB)</span>
<span class="kd">var</span> <span class="nx">exBuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExBuffer</span><span class="p">().</span><span class="nx">uint32Head</span><span class="p">().</span><span class="nx">bigEndian</span><span class="p">();</span>
<span class="nx">exBuffer</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'&gt;&gt; receive data,length:'</span><span class="o">+</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
<span class="p">});</span>
<span class="kd">var</span> <span class="nx">sbuf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="nx">sbuf</span><span class="p">.</span><span class="nx">writeUInt32BE</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">20</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span><span class="c1">//写入包长</span>
<span class="nx">exBuffer</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">sbuf</span><span class="p">);</span>
<span class="nx">exBuffer</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">20</span><span class="p">));</span>


<span class="cm">/*************************在socket中的应用****************************/</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'-----------------------use in socket------------------------'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">net</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'net'</span><span class="p">);</span>

<span class="c1">//测试服务端</span>
<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'client connected'</span><span class="p">);</span>
  <span class="k">new</span> <span class="nx">Connection</span><span class="p">(</span><span class="nx">socket</span><span class="p">);</span><span class="c1">//有客户端连入时</span>
<span class="p">});</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8124</span><span class="p">);</span>

<span class="c1">//服务端中映射客户端的类</span>
<span class="kd">function</span> <span class="nx">Connection</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">exBuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExBuffer</span><span class="p">();</span>
    <span class="nx">exBuffer</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span><span class="nx">onReceivePackData</span><span class="p">);</span>

    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">exBuffer</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="c1">//只要收到数据就往ExBuffer里面put</span>
    <span class="p">});</span>

    <span class="c1">//当服务端收到完整的包时</span>
    <span class="kd">function</span> <span class="nx">onReceivePackData</span><span class="p">(</span><span class="nx">buffer</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'&gt;&gt; server receive data,length:'</span><span class="o">+</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>

        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="s1">'wellcom, I am server'</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

        <span class="c1">//写入2个字节表示本次包长</span>
        <span class="kd">var</span> <span class="nx">headBuf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="nx">headBuf</span><span class="p">.</span><span class="nx">writeUInt16BE</span><span class="p">(</span><span class="nx">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">headBuf</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">bodyBuf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">len</span><span class="p">);</span>
        <span class="nx">bodyBuf</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">bodyBuf</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//测试客户端</span>
<span class="kd">var</span> <span class="nx">exBuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ExBuffer</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="mi">8124</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="s1">'hello I am client'</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

  <span class="c1">//写入2个字节表示本次包长</span>
  <span class="kd">var</span> <span class="nx">headBuf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
  <span class="nx">headBuf</span><span class="p">.</span><span class="nx">writeUInt16BE</span><span class="p">(</span><span class="nx">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">headBuf</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">bodyBuf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">len</span><span class="p">);</span>
  <span class="nx">bodyBuf</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">bodyBuf</span><span class="p">);</span>

<span class="p">});</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">exBuffer</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="c1">//只要收到数据就往ExBuffer里面put</span>
<span class="p">});</span>

<span class="c1">//当客户端收到完整的数据包时</span>
<span class="nx">exBuffer</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'&gt;&gt; client receive data,length:'</span><span class="o">+</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
<span class="p">});</span>

</pre>
</div>


<p>安装</p>

<div class="highlight">
<pre><span class="nx">npm</span> <span class="nx">install</span> <span class="nx">ExBuffer</span>
</pre>
</div>

      </section>
    </div>
    <footer>
      <p>Project maintained by <a href="https://github.com/play175">play175</a></p>
      <p>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></p>
    </footer>
    <!--[if !IE]><script>fixScale(document);</script><!--<![endif]-->
    
  </body>
</html>